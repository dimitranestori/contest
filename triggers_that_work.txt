--triggers


DELIMITER $$

CREATE OR REPLACE PROCEDURE different_cuisines_in_each_episode(IN vepisodeId INT)
BEGIN
    DECLARE count INT;

    SELECT COUNT(*)
    INTO count
    FROM (
        SELECT CuisineID
        FROM assignment
        INNER JOIN recipe ON assignment.RecipeID = recipe.RecipeID
        WHERE assignment.EpisodeID = vepisodeId
        GROUP BY CuisineID
        HAVING COUNT(*) > 1
    ) AS cuisineDuplicates;

    IF (count > 0) THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Each recipe in an episode must be from a different cuisine.';
    END IF;
END$$

CREATE  OR REPLACE TRIGGER different_cuisines_in_each_episode_trg
BEFORE INSERT ON assignment
FOR EACH ROW
BEGIN
    CALL different_cuisines_in_each_episode(NEW.EpisodeID);
END$$



CREATE  OR REPLACE TRIGGER assignments_per_episode_trg
BEFORE INSERT ON `assignment`
FOR EACH ROW
BEGIN
    DECLARE assignment_count INT;

    SELECT COUNT(*)
    INTO assignment_count
    FROM `assignment`
    WHERE `EpisodeID` = NEW.`EpisodeID`;

    IF assignment_count > 10 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Each episode must have 10 assignments.';
    END IF;
END $$




CREATE  OR REPLACE TRIGGER `participation_as_chef_or_judge_trg` 
BEFORE INSERT ON `assignment`
FOR EACH ROW
BEGIN
    DECLARE is_judge INT;

    -- Check if the chef is a judge in the same episode
    SELECT COUNT(*)
    INTO is_judge
    FROM `judge`
    WHERE `EpisodeID` = NEW.`EpisodeID`
      AND `ChefID` = NEW.`ChefID`;

    -- If the chef is already a judge, prevent the insert
    IF is_judge > 0 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'A chef cannot participate in the same episode as both a judge and a participant in the assignment.';
    END IF;
END $$

DELIMITER ;


DELIMITER $$

CREATE OR REPLACE PROCEDURE three_grades_for_assignment(IN asID INT)
BEGIN
    DECLARE gradeCount INT;

    SELECT COUNT(*)
    INTO gradeCount
    FROM grades
    WHERE AssignmentID = asID;

    IF gradeCount > 3 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Each assignment must have three grades.';
    END IF;
END$$

DELIMITER ;

DELIMITER $$

CREATE OR REPLACE TRIGGER three_grades_for_assignment_trg
AFTER INSERT ON grades
FOR EACH ROW
BEGIN
    CALL three_grades_for_assignment(NEW.AssignmentID);
END$$

DELIMITER ;





DELIMITER $$

CREATE OR REPLACE PROCEDURE one_chef_participation_per_episode(IN VchefId INT, IN VepisodeId INT)
BEGIN
    DECLARE assignmentCount INT;
    DECLARE judgeCount INT;

    -- Count assignments for the chef in the episode
    SELECT COUNT(*)
    INTO assignmentCount
    FROM assignment
    WHERE ChefID = VchefId AND EpisodeID = VepisodeId;

    -- Count judge roles for the chef in the episode
    SELECT COUNT(*)
    INTO judgeCount
    FROM judge
    WHERE ChefID = VchefId AND EpisodeID = VepisodeId;

    -- Raise an error if both counts are greater than zero
    IF (assignmentCount > 0 AND judgeCount > 0) THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Chef cannot be assigned to both a judge and an assignment in the same episode.';
    END IF;
END$$

DELIMITER ;

DELIMITER $$

CREATE OR REPLACE TRIGGER one_chef_participation_per_episode_trg
BEFORE INSERT ON assignment
FOR EACH ROW
BEGIN
    CALL one_chef_participation_per_episode(NEW.ChefID, NEW.EpisodeID);
END$$

DELIMITER ;

DELIMITER $$

CREATE OR REPLACE TRIGGER one_judge_participation_per_episode_trg
BEFORE INSERT ON judge
FOR EACH ROW
BEGIN
    CALL one_chef_participation_per_episode(NEW.ChefID, NEW.EpisodeID);
END$$

DELIMITER ;




DELIMITER $$

CREATE OR REPLACE TRIGGER cheff_recipe_can_cook_trg
BEFORE INSERT ON isabletocook
FOR EACH ROW
BEGIN
    -- Variable declaration
    DECLARE chef_specializationcuisine INT;
    DECLARE recipe_cuisinerecipebelongs INT;
    
    -- Retrieve the chef's specialization cuisine
    SELECT CuisineID INTO chef_specializationcuisine FROM specialises WHERE Chefid = NEW.Chefid;
    
    -- Retrieve the cuisineID of the recipe
    SELECT CuisineID INTO recipe_cuisinerecipebelongs FROM recipe WHERE Recipeid = NEW.Recipeid;

    -- Check if the chef's specialization cuisine matches the recipe's cuisine
    IF chef_specializationcuisine <> recipe_cuisinerecipebelongs THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Chef cannot cook this cuisine';
    END IF;
END$$

DELIMITER ;

